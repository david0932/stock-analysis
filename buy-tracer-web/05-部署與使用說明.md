# 股票買點追蹤 Web 系統 - 部署與使用說明

## 1. 快速開始

### 1.1 系統需求

#### 硬體需求
- **CPU**: 雙核心以上
- **記憶體**: 最低 2GB RAM（建議 4GB）
- **硬碟**: 最低 500MB 可用空間（含數據快取）

#### 軟體需求
- **作業系統**: Windows 10/11、macOS 10.15+、Ubuntu 20.04+
- **Python**: 3.9 或以上版本
- **瀏覽器**: Chrome 90+、Firefox 88+、Safari 14+、Edge 90+

### 1.2 環境準備

#### 安裝 Python

**Windows**:
```bash
# 下載 Python 安裝程式
https://www.python.org/downloads/

# 確認安裝
python --version
```

**macOS**:
```bash
# 使用 Homebrew
brew install python@3.11

# 確認安裝
python3 --version
```

**Linux (Ubuntu/Debian)**:
```bash
sudo apt update
sudo apt install python3.11 python3.11-venv python3-pip
python3 --version
```

## 2. 專案安裝

### 2.1 下載專案

```bash
# 從 Git 克隆（如果有版本控制）
git clone https://github.com/your-repo/buy-tracer-web.git
cd buy-tracer-web

# 或直接下載解壓縮
```

### 2.2 創建虛擬環境

**Windows**:
```bash
python -m venv venv
venv\Scripts\activate
```

**macOS/Linux**:
```bash
python3 -m venv venv
source venv/bin/activate
```

### 2.3 安裝依賴套件

```bash
# 升級 pip
pip install --upgrade pip

# 安裝專案依賴
pip install -r requirements.txt
```

#### `requirements.txt` 內容

```txt
# Web 框架
Flask==3.0.0
Flask-CORS==4.0.0

# 數據處理
pandas==2.1.4
numpy==1.26.2

# 股票數據源
twstock==1.3.1

# 圖表生成
plotly==5.18.0

# 環境變數管理
python-dotenv==1.0.0

# WSGI 服務器（生產環境）
gunicorn==21.2.0

# 工具套件
python-dateutil==2.8.2
pytz==2023.3

# 開發工具（可選）
pytest==7.4.3
black==23.12.1
flake8==7.0.0
```

### 2.4 環境變數設定

創建 `.env` 文件：

```bash
# 複製範例文件
cp .env.example .env

# 編輯設定
nano .env  # 或使用其他編輯器
```

#### `.env` 內容範例

```env
# Flask 配置
FLASK_APP=app.py
FLASK_ENV=development  # 開發環境使用 development，生產環境使用 production
SECRET_KEY=your-secret-key-here-change-in-production

# 服務器配置
HOST=0.0.0.0
PORT=5000

# 數據配置
DATA_DIR=data
CACHE_DIR=data/cache
LOG_DIR=data/logs

# 股票數據配置
DEFAULT_START_DATE=2024-01-01
DEFAULT_PLOT_DAYS=120

# 快取配置
CACHE_EXPIRY_DAYS=7
MAX_CACHE_SIZE_MB=100

# 速率限制
RATE_LIMIT_PER_MINUTE=10

# 日誌配置
LOG_LEVEL=INFO  # DEBUG, INFO, WARNING, ERROR
```

### 2.5 創建必要目錄

```bash
# Windows
mkdir data\cache data\logs data\metadata

# macOS/Linux
mkdir -p data/cache data/logs data/metadata
```

## 3. 啟動應用

### 3.1 開發模式

```bash
# 啟動 Flask 開發服務器
python app.py

# 或使用 flask run
flask run

# 訪問應用
http://localhost:5000
```

輸出範例：
```
 * Serving Flask app 'app'
 * Debug mode: on
 * Running on http://127.0.0.1:5000
Press CTRL+C to quit
```

### 3.2 生產模式

#### 使用 Gunicorn (Linux/macOS)

```bash
# 單 Worker
gunicorn -w 1 -b 0.0.0.0:5000 app:app

# 多 Worker（建議 2-4 個）
gunicorn -w 4 -b 0.0.0.0:5000 --timeout 120 app:app

# 背景執行
gunicorn -w 4 -b 0.0.0.0:5000 -D app:app
```

#### 使用 Waitress (Windows)

```bash
# 安裝 Waitress
pip install waitress

# 啟動
waitress-serve --host=0.0.0.0 --port=5000 app:app
```

## 4. 使用指南

### 4.1 首次使用

#### 步驟 1: 訪問首頁
開啟瀏覽器，訪問 `http://localhost:5000`

#### 步驟 2: 輸入股票代號
在首頁輸入框輸入台股代號，例如：
- `2330` (台積電)
- `3363` (上詮)
- `2454` (聯發科)

#### 步驟 3: 查看分析結果
系統會自動：
1. 下載歷史數據（從 2024-01-01 至前一日）
2. 計算技術指標
3. 生成買點訊號
4. 顯示互動式圖表

#### 步驟 4: 解讀結果
- **買點訊號摘要**: 顯示總訊號數、趨勢買點、拉回買點
- **K 線圖**: 顯示價格走勢、均線、買點標記
- **MACD 圖**: 顯示動能指標
- **訊號列表**: 詳細列出每個買點的參數

### 4.2 常用操作

#### 更新數據
```
點擊 "更新數據" 按鈕 → 自動補足至前一日收盤資料
```

#### 清除快取
```
點擊 "清除快取" 按鈕 → 刪除該股票快取，下次重新下載
```

#### 查看歷史記錄
```
導航欄 → 歷史記錄 → 查看所有已追蹤股票
```

## 5. 進階配置

### 5.1 自定義分析參數

修改 `config.py`：

```python
class Config:
    # 預設起始日期
    DEFAULT_START_DATE = '2024-01-01'

    # 預設繪圖天數
    DEFAULT_PLOT_DAYS = 120

    # 技術指標參數
    MA_PERIODS = [5, 20, 60]  # 移動平均線週期
    MACD_FAST = 12           # MACD 快線
    MACD_SLOW = 26           # MACD 慢線
    MACD_SIGNAL = 9          # MACD 訊號線

    # 買點策略參數
    VOLUME_THRESHOLD = 1.0   # 成交量倍數（1.0 = 5日均量）
```

### 5.2 修改圖表樣式

編輯 `services/chart_service.py`：

```python
# K 線圖顏色
CANDLESTICK_COLORS = {
    'increasing': '#dc2626',  # 紅漲
    'decreasing': '#16a34a'   # 綠跌
}

# 均線顏色
MA_COLORS = {
    'ma5': '#f59e0b',   # 橘色
    'ma20': '#3b82f6',  # 藍色
    'ma60': '#8b5cf6'   # 紫色
}
```

### 5.3 啟用日誌記錄

修改 `.env`：

```env
LOG_LEVEL=DEBUG
LOG_FILE=data/logs/app.log
```

查看日誌：

```bash
# 即時查看（Linux/macOS）
tail -f data/logs/app.log

# Windows (PowerShell)
Get-Content data\logs\app.log -Wait
```

## 6. 疑難排解

### 6.1 常見問題

#### Q1: 無法啟動服務器

**症狀**: `Address already in use`

**解決方法**:
```bash
# 查找佔用端口的進程（Windows）
netstat -ano | findstr :5000

# 終止進程（替換 PID）
taskkill /PID <PID> /F

# Linux/macOS
lsof -ti:5000 | xargs kill -9
```

或更換端口：
```bash
flask run --port=5001
```

#### Q2: twstock 下載失敗

**症狀**: `EXTERNAL_API_ERROR` 或 `Connection timeout`

**可能原因**:
1. 網路連線問題
2. twstock 服務暫時不可用
3. 請求過於頻繁

**解決方法**:
```python
# 在 services/stock_data_service.py 增加重試機制
import time

def fetch_with_retry(ticker, year, month, max_retries=3):
    for i in range(max_retries):
        try:
            stock = twstock.Stock(ticker)
            data = stock.fetch(year, month)
            return data
        except Exception as e:
            if i < max_retries - 1:
                time.sleep(2 ** i)  # 指數退避
            else:
                raise e
```

#### Q3: JSON 快取損壞

**症狀**: `JSONDecodeError` 或資料讀取失敗

**解決方法**:
```bash
# 刪除損壞的快取
rm data/cache/2330.json  # Linux/macOS
del data\cache\2330.json  # Windows

# 或清空所有快取
rm data/cache/*.json  # Linux/macOS
del data\cache\*.json  # Windows
```

#### Q4: 記憶體不足

**症狀**: 分析大量股票時記憶體使用過高

**解決方法**:
```python
# 在 config.py 限制快取數量
MAX_CACHED_STOCKS = 20

# 實作 LRU（最近最少使用）清理
def cleanup_old_caches():
    cache_files = sorted(
        glob.glob('data/cache/*.json'),
        key=os.path.getmtime
    )

    if len(cache_files) > MAX_CACHED_STOCKS:
        for file in cache_files[:-MAX_CACHED_STOCKS]:
            os.remove(file)
```

### 6.2 效能優化

#### 加速 JSON 序列化

```bash
pip install ujson
```

```python
# 在 utils/cache_manager.py
import ujson as json  # 替換內建 json
```

#### 使用 Redis 快取（進階）

```bash
pip install redis flask-caching
```

```python
from flask_caching import Cache

cache = Cache(app, config={
    'CACHE_TYPE': 'RedisCache',
    'CACHE_REDIS_HOST': 'localhost',
    'CACHE_REDIS_PORT': 6379
})
```

## 7. 部署到生產環境

### 7.1 使用 Nginx + Gunicorn

#### 安裝 Nginx (Ubuntu)

```bash
sudo apt update
sudo apt install nginx
```

#### Nginx 配置

創建 `/etc/nginx/sites-available/buy-tracer-web`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超時設定
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # 靜態文件
    location /static {
        alias /path/to/buy-tracer-web/static;
        expires 30d;
    }
}
```

啟用配置：

```bash
sudo ln -s /etc/nginx/sites-available/buy-tracer-web /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### Systemd 服務

創建 `/etc/systemd/system/buy-tracer-web.service`：

```ini
[Unit]
Description=Buy Tracer Web Application
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/path/to/buy-tracer-web
Environment="PATH=/path/to/buy-tracer-web/venv/bin"
ExecStart=/path/to/buy-tracer-web/venv/bin/gunicorn \
    -w 4 \
    -b 127.0.0.1:5000 \
    --timeout 120 \
    app:app

[Install]
WantedBy=multi-user.target
```

啟動服務：

```bash
sudo systemctl daemon-reload
sudo systemctl start buy-tracer-web
sudo systemctl enable buy-tracer-web
sudo systemctl status buy-tracer-web
```

### 7.2 使用 Docker

#### Dockerfile

```dockerfile
FROM python:3.11-slim

# 設定工作目錄
WORKDIR /app

# 安裝系統依賴
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 複製依賴文件
COPY requirements.txt .

# 安裝 Python 依賴
RUN pip install --no-cache-dir -r requirements.txt

# 複製應用程式
COPY . .

# 創建數據目錄
RUN mkdir -p data/cache data/logs data/metadata

# 暴露端口
EXPOSE 5000

# 啟動命令
CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "--timeout", "120", "app:app"]
```

#### docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    volumes:
      - ./data:/app/data
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=your-secret-key-change-me
    restart: unless-stopped

  # 可選：Redis 快取
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    restart: unless-stopped
```

#### 啟動 Docker 容器

```bash
# 建置映像
docker-compose build

# 啟動服務
docker-compose up -d

# 查看日誌
docker-compose logs -f

# 停止服務
docker-compose down
```

### 7.3 使用雲端平台

#### Heroku

```bash
# 安裝 Heroku CLI
# https://devcenter.heroku.com/articles/heroku-cli

# 登入
heroku login

# 創建應用
heroku create buy-tracer-web

# 部署
git push heroku main

# 設定環境變數
heroku config:set FLASK_ENV=production
heroku config:set SECRET_KEY=your-secret-key

# 查看日誌
heroku logs --tail
```

`Procfile`:
```
web: gunicorn -w 4 -b 0.0.0.0:$PORT app:app
```

## 8. 維護與監控

### 8.1 定期備份

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="backups/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# 備份快取數據
cp -r data/cache $BACKUP_DIR/

# 壓縮
tar -czf $BACKUP_DIR.tar.gz $BACKUP_DIR
rm -rf $BACKUP_DIR

# 刪除 30 天前的備份
find backups/ -name "*.tar.gz" -mtime +30 -delete
```

設定 Crontab（每日凌晨 2 點執行）：

```bash
crontab -e

# 添加
0 2 * * * /path/to/buy-tracer-web/backup.sh
```

### 8.2 日誌輪轉

安裝 `logrotate`（Ubuntu）：

創建 `/etc/logrotate.d/buy-tracer-web`：

```
/path/to/buy-tracer-web/data/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 www-data www-data
}
```

### 8.3 健康檢查

添加健康檢查端點（`app.py`）：

```python
@app.route('/health')
def health_check():
    return {
        'status': 'healthy',
        'timestamp': datetime.now().isoformat(),
        'cache_count': len(os.listdir('data/cache'))
    }
```

使用 `curl` 監控：

```bash
# 簡單檢查
curl http://localhost:5000/health

# 持續監控
watch -n 60 'curl -s http://localhost:5000/health | jq'
```

## 9. 安全性建議

### 9.1 變更預設密鑰

```bash
# 生成安全的 SECRET_KEY
python -c "import secrets; print(secrets.token_hex(32))"

# 更新 .env
SECRET_KEY=生成的密鑰
```

### 9.2 啟用 HTTPS

使用 Let's Encrypt (Nginx)：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 9.3 設定防火牆

```bash
# Ubuntu (UFW)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

## 10. 更新與升級

### 10.1 更新依賴套件

```bash
# 激活虛擬環境
source venv/bin/activate  # Linux/macOS
venv\Scripts\activate     # Windows

# 更新套件
pip install --upgrade -r requirements.txt

# 或更新單一套件
pip install --upgrade flask
```

### 10.2 版本遷移

查看版本號（`app.py`）：

```python
__version__ = '1.0.0'

@app.route('/version')
def version():
    return {'version': __version__}
```

---

**文件版本**: 1.0
**最後更新**: 2025-12-09
**適用系統**: Buy Tracer Web v1.0

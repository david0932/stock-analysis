# 股票買點追蹤 Web 系統 - 資料存儲格式

## 1. 存儲架構概述

### 1.1 存儲方式
- **主要格式**: JSON (JavaScript Object Notation)
- **文件系統**: 本地檔案系統
- **目錄結構**: 扁平化單層目錄

### 1.2 設計理念
- ✅ **簡單性**: 無需資料庫，降低部署複雜度
- ✅ **可讀性**: JSON 格式易於人工檢查與除錯
- ✅ **可移植性**: 檔案可直接複製與備份
- ✅ **效能**: 適合中小規模數據（單檔 < 1MB）

### 1.3 存儲路徑結構

```
buy-tracer-web/
└── data/
    ├── cache/                    # 股票數據快取
    │   ├── 2330.json            # 台積電
    │   ├── 3363.json            # 上詮
    │   ├── 2454.json            # 聯發科
    │   └── ...
    ├── metadata/                 # 元數據（可選）
    │   └── stock_names.json     # 股票代號與名稱對照表
    └── logs/                     # 日誌文件
        ├── app.log
        └── data_update.log
```

## 2. 股票數據快取格式

### 2.1 檔案命名規則
- **格式**: `{ticker}.json`
- **範例**: `2330.json`, `3363.json`
- **字符集**: ASCII 數字
- **大小寫**: 統一使用原始代號（通常為數字）

### 2.2 JSON 結構定義

#### 完整範例 (`2330.json`)

```json
{
  "metadata": {
    "ticker": "2330",
    "stock_name": "台積電",
    "data_source": "twstock",
    "created_at": "2024-12-01T10:00:00+08:00",
    "last_update": "2024-12-09T09:00:00+08:00",
    "version": "1.0"
  },
  "date_range": {
    "start_date": "2024-01-01",
    "end_date": "2024-12-08",
    "total_trading_days": 240
  },
  "data": [
    {
      "date": "2024-01-02",
      "open": 590.0,
      "high": 595.0,
      "low": 588.0,
      "close": 592.0,
      "volume": 45678900,
      "capacity": 27041908800
    },
    {
      "date": "2024-01-03",
      "open": 593.0,
      "high": 598.0,
      "low": 591.0,
      "close": 596.0,
      "volume": 48923400,
      "capacity": 29126266400
    },
    // ... 更多交易日數據
    {
      "date": "2024-12-08",
      "open": 982.0,
      "high": 988.0,
      "low": 980.0,
      "close": 985.0,
      "volume": 42567800,
      "capacity": 41929203000
    }
  ]
}
```

### 2.3 欄位說明

#### metadata 區塊
| 欄位 | 類型 | 必填 | 說明 |
|------|------|------|------|
| ticker | string | 是 | 股票代號 |
| stock_name | string | 是 | 股票名稱 |
| data_source | string | 是 | 數據來源（固定為 "twstock"） |
| created_at | string | 是 | 快取創建時間 (ISO 8601) |
| last_update | string | 是 | 最後更新時間 (ISO 8601) |
| version | string | 是 | 數據格式版本號 |

#### date_range 區塊
| 欄位 | 類型 | 必填 | 說明 |
|------|------|------|------|
| start_date | string | 是 | 數據起始日期 (YYYY-MM-DD) |
| end_date | string | 是 | 數據結束日期 (YYYY-MM-DD) |
| total_trading_days | integer | 是 | 總交易日數量 |

#### data 陣列（每日數據）
| 欄位 | 類型 | 必填 | 單位 | 說明 |
|------|------|------|------|------|
| date | string | 是 | - | 交易日期 (YYYY-MM-DD) |
| open | float | 是 | 元 | 開盤價 |
| high | float | 是 | 元 | 最高價 |
| low | float | 是 | 元 | 最低價 |
| close | float | 是 | 元 | 收盤價 |
| volume | integer | 是 | 股 | 成交股數 |
| capacity | integer | 否 | 元 | 成交金額 |

### 2.4 數據驗證規則

#### 日期格式
```python
# 必須符合 ISO 8601 日期格式
pattern = r'^\d{4}-\d{2}-\d{2}$'
example = "2024-12-09"  # ✅ 正確
invalid = "2024/12/09"  # ❌ 錯誤
```

#### 價格數據
```python
# 價格必須為正數，保留兩位小數
assert open > 0
assert high >= open and high >= close
assert low <= open and low <= close
assert close > 0
```

#### 成交量
```python
# 成交量必須為非負整數
assert volume >= 0
assert isinstance(volume, int)
```

#### 日期連續性
```python
# data 陣列必須按日期升序排列
dates = [item['date'] for item in data['data']]
assert dates == sorted(dates)
```

## 3. 元數據文件格式

### 3.1 股票名稱對照表 (`metadata/stock_names.json`)

```json
{
  "version": "1.0",
  "last_update": "2024-12-09T10:00:00+08:00",
  "stocks": {
    "2330": {
      "name": "台積電",
      "name_en": "TSMC",
      "industry": "半導體",
      "market": "上市"
    },
    "3363": {
      "name": "上詮",
      "name_en": "Upmost",
      "industry": "電腦週邊",
      "market": "上市"
    },
    "2454": {
      "name": "聯發科",
      "name_en": "MediaTek",
      "industry": "半導體",
      "market": "上市"
    }
  }
}
```

### 3.2 快取索引文件 (`metadata/cache_index.json`)

**功能**: 快速查詢所有已快取的股票資訊

```json
{
  "version": "1.0",
  "last_update": "2024-12-09T10:30:00+08:00",
  "total_count": 3,
  "stocks": [
    {
      "ticker": "2330",
      "stock_name": "台積電",
      "file_path": "data/cache/2330.json",
      "file_size_kb": 256,
      "date_range": {
        "start": "2024-01-01",
        "end": "2024-12-08",
        "total_days": 240
      },
      "last_update": "2024-12-09T09:00:00+08:00"
    },
    {
      "ticker": "3363",
      "stock_name": "上詮",
      "file_path": "data/cache/3363.json",
      "file_size_kb": 245,
      "date_range": {
        "start": "2024-01-01",
        "end": "2024-12-08",
        "total_days": 238
      },
      "last_update": "2024-12-08T15:30:00+08:00"
    }
  ]
}
```

## 4. 快取管理策略

### 4.1 增量更新邏輯

#### 更新觸發條件
```python
def should_update(cache_data):
    """
    檢查是否需要更新快取
    """
    end_date = datetime.strptime(cache_data['date_range']['end_date'], '%Y-%m-%d')
    yesterday = datetime.now() - timedelta(days=1)

    # 如果最新日期 < 昨天，則需要更新
    return end_date.date() < yesterday.date()
```

#### 缺失日期計算
```python
def get_missing_dates(start_date, end_date):
    """
    計算需要補足的交易日（排除週末）
    """
    missing_dates = []
    current = start_date + timedelta(days=1)

    while current <= end_date:
        # 排除週六(5)和週日(6)
        if current.weekday() < 5:
            missing_dates.append(current.strftime('%Y-%m-%d'))
        current += timedelta(days=1)

    return missing_dates
```

#### 數據合併
```python
def merge_data(existing_data, new_data):
    """
    合併既有數據與新數據
    """
    # 1. 讀取既有數據
    df_existing = pd.DataFrame(existing_data['data'])

    # 2. 轉換新數據
    df_new = pd.DataFrame(new_data)

    # 3. 合併（避免重複）
    df_merged = pd.concat([df_existing, df_new]).drop_duplicates(subset=['date'])

    # 4. 排序
    df_merged = df_merged.sort_values('date')

    # 5. 更新元數據
    existing_data['data'] = df_merged.to_dict('records')
    existing_data['date_range']['end_date'] = df_merged['date'].iloc[-1]
    existing_data['date_range']['total_trading_days'] = len(df_merged)
    existing_data['metadata']['last_update'] = datetime.now().isoformat()

    return existing_data
```

### 4.2 快取過期策略

#### 軟過期（推薦）
```python
# 快取永不自動刪除，但會標記為 "需要更新"
CACHE_NEVER_EXPIRES = True
```

#### 硬過期（可選）
```python
# 超過 N 天未更新的快取視為過期
CACHE_EXPIRY_DAYS = 7

def is_cache_expired(last_update):
    last_update_dt = datetime.fromisoformat(last_update)
    age_days = (datetime.now() - last_update_dt).days
    return age_days > CACHE_EXPIRY_DAYS
```

### 4.3 快取容量管理

#### 單檔案大小限制
```python
MAX_CACHE_FILE_SIZE_MB = 5  # 單個快取檔案最大 5MB

def check_file_size(file_path):
    size_mb = os.path.getsize(file_path) / (1024 * 1024)
    if size_mb > MAX_CACHE_FILE_SIZE_MB:
        # 觸發數據壓縮或清理舊數據
        compress_old_data(file_path)
```

#### 總快取大小限制
```python
MAX_TOTAL_CACHE_SIZE_MB = 100  # 總快取最大 100MB

def check_total_cache_size():
    total_size = sum(
        os.path.getsize(f)
        for f in glob.glob('data/cache/*.json')
    ) / (1024 * 1024)

    if total_size > MAX_TOTAL_CACHE_SIZE_MB:
        # 清理最舊的快取
        cleanup_oldest_caches()
```

## 5. 資料完整性

### 5.1 JSON Schema 驗證

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Stock Cache Data",
  "type": "object",
  "required": ["metadata", "date_range", "data"],
  "properties": {
    "metadata": {
      "type": "object",
      "required": ["ticker", "stock_name", "data_source", "created_at", "last_update", "version"],
      "properties": {
        "ticker": { "type": "string", "pattern": "^[0-9]{4,6}$" },
        "stock_name": { "type": "string" },
        "data_source": { "type": "string", "enum": ["twstock"] },
        "created_at": { "type": "string", "format": "date-time" },
        "last_update": { "type": "string", "format": "date-time" },
        "version": { "type": "string" }
      }
    },
    "date_range": {
      "type": "object",
      "required": ["start_date", "end_date", "total_trading_days"],
      "properties": {
        "start_date": { "type": "string", "format": "date" },
        "end_date": { "type": "string", "format": "date" },
        "total_trading_days": { "type": "integer", "minimum": 1 }
      }
    },
    "data": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["date", "open", "high", "low", "close", "volume"],
        "properties": {
          "date": { "type": "string", "format": "date" },
          "open": { "type": "number", "minimum": 0 },
          "high": { "type": "number", "minimum": 0 },
          "low": { "type": "number", "minimum": 0 },
          "close": { "type": "number", "minimum": 0 },
          "volume": { "type": "integer", "minimum": 0 },
          "capacity": { "type": "integer", "minimum": 0 }
        }
      }
    }
  }
}
```

### 5.2 錯誤處理

#### JSON 解析失敗
```python
def safe_load_cache(file_path):
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
        return data
    except json.JSONDecodeError as e:
        # JSON 損壞，記錄錯誤並刪除
        logger.error(f"JSON parse error: {file_path} - {e}")
        os.remove(file_path)
        return None
    except FileNotFoundError:
        return None
```

#### 數據校驗失敗
```python
def validate_cache_data(data):
    """
    驗證快取數據的完整性
    """
    errors = []

    # 檢查必要欄位
    required_keys = ['metadata', 'date_range', 'data']
    for key in required_keys:
        if key not in data:
            errors.append(f"Missing required key: {key}")

    # 檢查數據陣列
    if 'data' in data and len(data['data']) == 0:
        errors.append("Data array is empty")

    # 檢查日期順序
    if 'data' in data:
        dates = [item['date'] for item in data['data']]
        if dates != sorted(dates):
            errors.append("Dates are not in ascending order")

    return len(errors) == 0, errors
```

## 6. 備份與恢復

### 6.1 備份策略

#### 手動備份
```bash
# 備份整個 data 目錄
cp -r data/ data_backup_$(date +%Y%m%d)/
```

#### 自動備份（可選）
```python
import shutil
from datetime import datetime

def auto_backup():
    """
    每日自動備份快取目錄
    """
    timestamp = datetime.now().strftime('%Y%m%d')
    backup_dir = f"data_backup_{timestamp}"

    if not os.path.exists(backup_dir):
        shutil.copytree('data/cache', backup_dir)
        logger.info(f"Backup created: {backup_dir}")
```

### 6.2 恢復流程

```python
def restore_from_backup(backup_dir):
    """
    從備份恢復數據
    """
    if os.path.exists(backup_dir):
        # 清空當前快取
        shutil.rmtree('data/cache')

        # 恢復備份
        shutil.copytree(backup_dir, 'data/cache')
        logger.info(f"Restored from backup: {backup_dir}")
    else:
        logger.error(f"Backup directory not found: {backup_dir}")
```

## 7. 遷移與匯出

### 7.1 匯出為 CSV

```python
def export_to_csv(ticker):
    """
    將 JSON 快取匯出為 CSV 格式
    """
    with open(f'data/cache/{ticker}.json', 'r') as f:
        data = json.load(f)

    df = pd.DataFrame(data['data'])
    csv_path = f'exports/{ticker}.csv'
    df.to_csv(csv_path, index=False, encoding='utf-8-sig')

    return csv_path
```

### 7.2 匯入外部數據

```python
def import_from_csv(ticker, csv_path):
    """
    從 CSV 匯入數據並轉換為 JSON 快取
    """
    df = pd.read_csv(csv_path)

    cache_data = {
        "metadata": {
            "ticker": ticker,
            "stock_name": "未知",
            "data_source": "csv_import",
            "created_at": datetime.now().isoformat(),
            "last_update": datetime.now().isoformat(),
            "version": "1.0"
        },
        "date_range": {
            "start_date": df['date'].iloc[0],
            "end_date": df['date'].iloc[-1],
            "total_trading_days": len(df)
        },
        "data": df.to_dict('records')
    }

    with open(f'data/cache/{ticker}.json', 'w', encoding='utf-8') as f:
        json.dump(cache_data, f, ensure_ascii=False, indent=2)
```

## 8. 效能優化建議

### 8.1 JSON 序列化優化

```python
# 使用 ujson 加速序列化（可選）
import ujson

def save_cache_fast(ticker, data):
    with open(f'data/cache/{ticker}.json', 'w', encoding='utf-8') as f:
        ujson.dump(data, f, ensure_ascii=False, indent=2)
```

### 8.2 壓縮存儲（可選）

```python
import gzip
import json

def save_cache_compressed(ticker, data):
    """
    使用 gzip 壓縮 JSON（節省 60-80% 空間）
    """
    json_str = json.dumps(data, ensure_ascii=False, indent=2)
    with gzip.open(f'data/cache/{ticker}.json.gz', 'wt', encoding='utf-8') as f:
        f.write(json_str)
```

## 9. 文件權限與安全

### 9.1 文件權限設定

```bash
# Linux/Mac
chmod 755 data/cache/      # 目錄
chmod 644 data/cache/*.json  # 檔案

# Windows (PowerShell)
icacls data\cache /grant Users:RX
```

### 9.2 敏感資訊處理

```python
# 快取中不應包含敏感資訊
PROHIBITED_FIELDS = ['user_id', 'api_key', 'password']

def sanitize_data(data):
    """
    移除敏感欄位
    """
    for field in PROHIBITED_FIELDS:
        if field in data:
            del data[field]
    return data
```

---

**文件版本**: 1.0
**最後更新**: 2025-12-09
**數據格式版本**: 1.0

{% extends 'base.html' %}

{% block title %}首頁 - 股票買點追蹤系統{% endblock %}

{% block content %}
<!-- 頁首標題區 -->
<div class="text-center mb-5">
    <h1 class="display-4 fw-bold mb-3">
        <i class="bi bi-graph-up-arrow text-primary"></i>
        股票買賣點追蹤系統
    </h1>
    <p class="lead text-secondary">
        運用技術分析，智能追蹤台股買賣點訊號
    </p>
</div>

<!-- 股票代號輸入區 -->
<div class="row justify-content-center mb-5">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <form id="analyzeForm" onsubmit="submitAnalyze(event)">
                    <div class="input-group input-group-lg">
                        <input
                            type="text"
                            class="form-control"
                            id="tickerInput"
                            list="stocksList"
                            placeholder="輸入股票代號或名稱..."
                            required
                            autofocus
                            autocomplete="off"
                        >
                        <datalist id="stocksList">
                            <!-- 動態載入 -->
                        </datalist>
                        <button class="btn btn-primary" type="submit" id="analyzeBtn">
                            <i class="bi bi-search"></i> 分析
                        </button>
                    </div>
                    <div class="form-text mt-2">
                        <strong>常見股票:</strong> 2330 (台積電)、2454 (聯發科)、2317 (鴻海)、00983A (ETF)
                        <br>
                        <small class="text-muted">註: 支援輸入股票代號或名稱，包含 ETF（如：00983A）</small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 分析方法說明區 -->
<div class="row mb-5">
    <div class="col-md-4 mb-3">
        <div class="card h-100 border-primary">
            <div class="card-body text-center">
                <i class="bi bi-graph-up display-4 text-primary mb-3"></i>
                <h5 class="card-title">技術指標</h5>
                <p class="card-text text-secondary">
                    計算 MA5/MA20/MA60 移動平均線與 MACD 指標，
                    全面分析股價趨勢與動能。
                </p>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card h-100 border-success">
            <div class="card-body text-center">
                <i class="bi bi-bullseye display-4 text-success mb-3"></i>
                <h5 class="card-title">完整買賣策略</h5>
                <ul class="list-unstyled text-secondary small">
                    <li class="mb-1">📈 買點: 趨勢確立 / 拉回支撐</li>
                    <li>📉 賣點: 趨勢反轉 / MACD轉弱</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-3">
        <div class="card h-100 border-warning">
            <div class="card-body text-center">
                <i class="bi bi-bar-chart-line display-4 text-warning mb-3"></i>
                <h5 class="card-title">互動式圖表</h5>
                <p class="card-text text-secondary">
                    K 線圖、成交量、MACD 圖表動態呈現，
                    買點清晰標註。
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 買賣點策略詳細說明 -->
<div class="card mb-5">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> 買賣點策略說明</h5>
    </div>
    <div class="card-body">
        <!-- 買點策略 -->
        <div class="mb-4">
            <h5 class="text-success mb-3">📈 買點策略</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-success fw-bold">🚀 策略一：趨勢確立買點</h6>
                    <p class="text-secondary mb-2 small">適用於趨勢啟動初期，捕捉主升段行情</p>
                    <ul class="small">
                        <li>MA5 向上突破 MA20（黃金交叉）</li>
                        <li>多頭排列: MA5 > MA20 > MA60</li>
                        <li>成交量放大（大於 5 日均量）</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-success fw-bold">✨ 策略二：拉回支撐買點</h6>
                    <p class="text-secondary mb-2 small">適用於上升趨勢中的回檔，風險較低</p>
                    <ul class="small">
                        <li>MACD 維持多頭（DIF > DEM）</li>
                        <li>柱狀體二次翻紅（OSC 反彈）</li>
                        <li>收盤價守穩 MA20 支撐</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 賣點策略 -->
        <div>
            <h5 class="text-danger mb-3">📉 賣點策略</h5>
            <div class="row">
                <div class="col-md-6">
                    <h6 class="text-danger fw-bold">⬇️ 策略一：趨勢反轉賣點</h6>
                    <p class="text-secondary mb-2 small">趨勢結束信號，保護獲利及時退場</p>
                    <ul class="small">
                        <li>MA5 向下跌破 MA20（死亡交叉）</li>
                        <li>空頭排列: MA5 < MA20 < MA60</li>
                        <li>成交量放大（確認賣壓）</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="text-danger fw-bold">🔶 策略二：MACD 轉弱賣點</h6>
                    <p class="text-secondary mb-2 small">動能衰退警示，提早退場避險</p>
                    <ul class="small">
                        <li>MACD 轉空（DIF < DEM）</li>
                        <li>柱狀體持續下降（OSC 減弱）</li>
                        <li>收盤價跌破 MA20</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let stocksMap = {};  // 股票名稱到代號的映射
let allStocks = [];  // 所有股票列表
let loadingStocks = false;  // 是否正在載入
let stocksLoaded = false;  // 是否已載入
let searchTimeout = null;  // 搜尋防抖動計時器

// 頁面載入完成後設定事件監聽
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('tickerInput');

    // 當輸入框獲得焦點時才開始載入股票列表（延遲載入）
    input.addEventListener('focus', function() {
        if (!stocksLoaded && !loadingStocks) {
            loadStocksMapInBackground();
        }
    }, { once: true });  // 只執行一次

    // 監聽輸入事件，動態更新建議
    input.addEventListener('input', handleInputChange);
});

// 在背景載入股票映射表（不創建 DOM 元素）
async function loadStocksMapInBackground() {
    if (loadingStocks || stocksLoaded) return;

    loadingStocks = true;
    try {
        const response = await axios.get('/api/stocks/list');
        if (response.data.success) {
            allStocks = response.data.data.stocks;

            // 只建立映射表，不操作 DOM
            allStocks.forEach(stock => {
                stocksMap[stock.ticker] = stock.ticker;
                stocksMap[stock.name] = stock.ticker;
                stocksMap[stock.display.toLowerCase()] = stock.ticker;
            });

            stocksLoaded = true;
        }
    } catch (error) {
        console.error('載入股票列表失敗:', error);
    } finally {
        loadingStocks = false;
    }
}

// 處理輸入變化，動態更新建議
function handleInputChange(event) {
    const query = event.target.value.trim().toUpperCase();

    // 清除之前的計時器
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    // 如果輸入為空或少於 2 個字符，清空建議
    if (query.length < 2) {
        clearDatalist();
        return;
    }

    // 防抖動：等待 300ms 後再更新
    searchTimeout = setTimeout(() => {
        updateDatalist(query);
    }, 300);
}

// 更新 datalist 建議（限制顯示數量）
function updateDatalist(query) {
    if (!stocksLoaded) {
        return;
    }

    const datalist = document.getElementById('stocksList');
    datalist.innerHTML = '';  // 清空現有選項

    // 搜尋匹配的股票（限制最多 20 個）
    const matches = allStocks.filter(stock => {
        return stock.ticker.includes(query) ||
               stock.name.includes(query) ||
               stock.display.toUpperCase().includes(query);
    }).slice(0, 20);  // 只取前 20 個結果

    // 添加到 datalist
    matches.forEach(stock => {
        const option = document.createElement('option');
        option.value = stock.ticker;
        option.textContent = stock.display;
        datalist.appendChild(option);
    });
}

// 清空 datalist
function clearDatalist() {
    const datalist = document.getElementById('stocksList');
    datalist.innerHTML = '';
}

function submitAnalyze(event) {
    event.preventDefault();
    const input = document.getElementById('tickerInput').value.trim();

    if (!input) return;

    // 嘗試從輸入中提取股票代號
    let ticker = extractTicker(input);

    if (ticker) {
        window.location.href = `/analyze/${ticker}`;
    } else {
        showToast('請輸入有效的股票代號或名稱', 'warning');
    }
}

function extractTicker(input) {
    // 轉為大寫以統一處理
    const upperInput = input.toUpperCase();

    // 情況 1: 直接輸入股票代號（4-6位數字，或4-6位數字+1個字母）
    if (/^\d{4,6}[A-Z]?$/.test(upperInput)) {
        return upperInput;
    }

    // 情況 2: 完全匹配映射表中的項目（包括名稱）
    if (stocksMap[input]) {
        return stocksMap[input];
    }

    // 情況 3: 不區分大小寫匹配
    const lowerInput = input.toLowerCase();
    if (stocksMap[lowerInput]) {
        return stocksMap[lowerInput];
    }

    // 情況 4: 輸入包含股票代號和名稱（如 "2330 台積電" 或 "00983A XXX"）
    const match = input.match(/(\d{4,6}[A-Z]?)/i);
    if (match) {
        return match[1].toUpperCase();
    }

    // 情況 5: 精確匹配股票名稱（完整名稱）
    for (const [key, value] of Object.entries(stocksMap)) {
        if (key === input && !/^\d+[A-Z]?$/.test(key)) {
            return value;
        }
    }

    // 情況 6: 模糊匹配股票名稱（部分名稱）
    for (const [key, value] of Object.entries(stocksMap)) {
        if (key.includes(input) && !/^\d+[A-Z]?$/.test(key) && input.length >= 2) {
            return value;
        }
    }

    return null;
}
</script>
{% endblock %}

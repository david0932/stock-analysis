{% extends 'base.html' %}

{% block title %}{{ ticker }} - æŠ€è¡“åˆ†æ{% endblock %}

{% block content %}
<!-- è¼‰å…¥ä¸­æç¤º -->
<div id="loadingIndicator" class="text-center my-5">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">åˆ†æä¸­...</span>
    </div>
    <p class="mt-3 text-secondary">æ­£åœ¨åˆ†æ {{ ticker }}ï¼Œè«‹ç¨å€™...</p>
</div>

<!-- åˆ†æçµæœå€ï¼ˆåˆå§‹éš±è—ï¼‰ -->
<div id="analysisResult" style="display: none;">

    <!-- è‚¡ç¥¨è³‡è¨Šå¡ç‰‡ -->
    <div class="card mb-4 border-primary">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div class="mb-2 mb-md-0">
                    <h3 class="mb-1">
                        <span id="stockName">{{ ticker }}</span>
                        <span class="text-secondary">(<span id="stockTicker">{{ ticker }}</span>)</span>
                    </h3>
                    <p class="text-secondary mb-0">
                        æœ€æ–°æ”¶ç›¤: <span class="fs-4 fw-bold text-primary" id="latestClose">-</span>
                        <span class="ms-3 small">æ—¥æœŸ: <span id="latestDate">-</span></span>
                    </p>
                </div>
                <div>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> è¿”å›
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- è²·é»è¨Šè™Ÿæ‘˜è¦ -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h6 class="text-secondary small">ç¸½è¨Šè™Ÿæ•¸</h6>
                    <h2 class="text-primary mb-0 fw-bold" id="totalSignals">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h6 class="text-secondary small">ğŸš€ è¶¨å‹¢è²·é»</h6>
                    <h2 class="text-success mb-0 fw-bold" id="type1Signals">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h6 class="text-secondary small">âœ¨ æ‹‰å›è²·é»</h6>
                    <h2 class="text-info mb-0 fw-bold" id="type2Signals">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ€æ–°è¨Šè™Ÿæç¤º -->
    <div id="latestSignalAlert" class="alert" role="alert" style="display: none;">
        <!-- å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- K ç·šåœ– -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> K ç·šåœ– & ç§»å‹•å¹³å‡ç·š</h5>
        </div>
        <div class="card-body">
            <div id="candlestickChart"></div>
        </div>
    </div>

    <!-- æˆäº¤é‡åœ– -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> æˆäº¤é‡</h5>
        </div>
        <div class="card-body">
            <div id="volumeChart"></div>
        </div>
    </div>

    <!-- MACD åœ– -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-activity"></i> MACD æŒ‡æ¨™</h5>
        </div>
        <div class="card-body">
            <div id="macdChart"></div>
        </div>
    </div>

    <!-- è¨Šè™Ÿè©³ç´°åˆ—è¡¨ -->
    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> è²·é»è¨Šè™Ÿè©³ç´°åˆ—è¡¨</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="signalTable">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>è¨Šè™Ÿé¡å‹</th>
                            <th>æ”¶ç›¤åƒ¹</th>
                            <th>MA20</th>
                            <th>æˆäº¤é‡</th>
                            <th>DIF</th>
                            <th>DEM</th>
                            <th>OSC</th>
                        </tr>
                    </thead>
                    <tbody id="signalTableBody">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="text-center mb-4">
        <button class="btn btn-primary" id="updateBtn" onclick="forceUpdate()">
            <i class="bi bi-arrow-clockwise"></i> æ›´æ–°æ•¸æ“š
        </button>
        <button class="btn btn-warning" id="clearCacheBtn" onclick="clearCache()">
            <i class="bi bi-trash"></i> æ¸…é™¤å¿«å–
        </button>
    </div>

</div>

<!-- éŒ¯èª¤è¨Šæ¯å€ -->
<div id="errorMessage" class="alert alert-danger" role="alert" style="display: none;">
    <!-- å‹•æ…‹è¼‰å…¥ -->
</div>

{% endblock %}

{% block extra_scripts %}
<script>
const TICKER = '{{ ticker }}';

// é é¢è¼‰å…¥æ™‚ç«‹å³é–‹å§‹åˆ†æ
document.addEventListener('DOMContentLoaded', function() {
    analyzeStock(TICKER);
});

async function analyzeStock(ticker) {
    try {
        document.getElementById('loadingIndicator').style.display = 'block';
        document.getElementById('analysisResult').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';

        const response = await axios.post('/api/analyze', {
            ticker: ticker,
            start_date: '2024-01-01',
            days: 120
        });

        if (response.data.success) {
            renderAnalysisResult(response.data.data);
        }

    } catch (error) {
        showError(error);
    } finally {
        document.getElementById('loadingIndicator').style.display = 'none';
    }
}

function renderAnalysisResult(data) {
    // æ›´æ–°è‚¡ç¥¨è³‡è¨Š
    document.getElementById('stockName').textContent = data.stock_name || data.ticker;
    document.getElementById('stockTicker').textContent = data.ticker;
    document.getElementById('latestClose').textContent = data.latest_data.close.toLocaleString('zh-TW');
    document.getElementById('latestDate').textContent = data.latest_data.date;

    // æ›´æ–°è¨Šè™Ÿæ‘˜è¦
    document.getElementById('totalSignals').textContent = data.signals.total_count;
    document.getElementById('type1Signals').textContent = data.signals.type1_count;
    document.getElementById('type2Signals').textContent = data.signals.type2_count;

    // é¡¯ç¤ºæœ€æ–°è¨Šè™Ÿ
    if (data.signals.latest_signal) {
        const alert = document.getElementById('latestSignalAlert');
        alert.className = 'alert alert-success';
        alert.style.display = 'block';
        alert.innerHTML = `
            <strong>ğŸ¯ æœ€æ–°è¨Šè™Ÿ:</strong> ${data.signals.latest_signal.type}
            (${data.signals.latest_signal.date}) - æ”¶ç›¤åƒ¹: ${data.signals.latest_signal.close}
        `;
    }

    // æ¸²æŸ“åœ–è¡¨
    const config = {responsive: true, displayModeBar: true, displaylogo: false};
    Plotly.newPlot('candlestickChart', data.chart.candlestick.data, data.chart.candlestick.layout, config);
    Plotly.newPlot('volumeChart', data.chart.volume.data, data.chart.volume.layout, config);
    Plotly.newPlot('macdChart', data.chart.macd.data, data.chart.macd.layout, config);

    // è§¸ç™¼çª—å£ resize ä»¥ç¢ºä¿åœ–è¡¨é©æ‡‰å®¹å™¨
    setTimeout(() => {
        window.dispatchEvent(new Event('resize'));
    }, 100);

    // æ¸²æŸ“è¨Šè™Ÿè¡¨æ ¼
    renderSignalTable(data.signals.recent_signals);

    // é¡¯ç¤ºçµæœå€
    document.getElementById('analysisResult').style.display = 'block';
}

function renderSignalTable(signals) {
    const tbody = document.getElementById('signalTableBody');
    tbody.innerHTML = '';

    signals.reverse().forEach(signal => {
        const row = `
            <tr>
                <td>${signal.date}</td>
                <td><span class="badge bg-primary">${signal.signal_type}</span></td>
                <td>${signal.close.toLocaleString('zh-TW')}</td>
                <td>${signal.ma20.toLocaleString('zh-TW')}</td>
                <td>${signal.volume.toLocaleString('zh-TW')}</td>
                <td>${signal.dif.toFixed(2)}</td>
                <td>${signal.dem.toFixed(2)}</td>
                <td>${signal.osc.toFixed(2)}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function showError(error) {
    const errorDiv = document.getElementById('errorMessage');
    let message = 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';

    if (error.response && error.response.data) {
        message = error.response.data.error.message || message;
    }

    // å°‡æ›è¡Œç¬¦è™Ÿè½‰æ›ç‚º HTML æ›è¡Œ
    const formattedMessage = message.replace(/\n/g, '<br>');
    errorDiv.innerHTML = `<strong>éŒ¯èª¤:</strong> ${formattedMessage}`;
    errorDiv.style.display = 'block';
}

async function forceUpdate() {
    if (!confirm('ç¢ºå®šè¦å¼·åˆ¶æ›´æ–°æ•¸æ“šå—ï¼Ÿ')) return;

    try {
        const response = await axios.post(`/api/update/${TICKER}`);
        if (response.data.success) {
            showToast('æ•¸æ“šæ›´æ–°æˆåŠŸ', 'success');
            setTimeout(() => analyzeStock(TICKER), 1000);
        }
    } catch (error) {
        showToast('æ›´æ–°å¤±æ•—: ' + error.response.data.error.message, 'danger');
    }
}

async function clearCache() {
    if (!confirm('ç¢ºå®šè¦æ¸…é™¤å¿«å–å—ï¼Ÿæ¸…é™¤å¾Œå°‡é‡æ–°ä¸‹è¼‰æ•¸æ“šã€‚')) return;

    try {
        const response = await axios.delete(`/api/cache/${TICKER}`);
        if (response.data.success) {
            showToast('å¿«å–å·²æ¸…é™¤', 'success');
            setTimeout(() => window.location.href = '/', 1000);
        }
    } catch (error) {
        showToast('æ¸…é™¤å¤±æ•—: ' + error.response.data.error.message, 'danger');
    }
}
</script>
{% endblock %}

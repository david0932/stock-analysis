version: '3.8'

services:
  # 主應用服務
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: stock-analysis-app:latest
    container_name: stock-analysis-app
    restart: unless-stopped
    ports:
      - "5000:5000"
    environment:
      - FLASK_ENV=production
      - HOST=0.0.0.0
      - PORT=5000
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - DEFAULT_START_DATE=2024-01-01
      - DEFAULT_PLOT_DAYS=120
      - LOG_LEVEL=INFO
      - TZ=Asia/Taipei
    volumes:
      # 持久化數據目錄（快取、日誌等）
      - app-data:/app/data
      # 同步宿主機時區設定
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - stock-network
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Nginx 反向代理（可選，用於生產環境）
  nginx:
    image: nginx:alpine
    container_name: stock-analysis-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-cache:/var/cache/nginx
      # SSL 證書（如果使用 HTTPS）
      # - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    networks:
      - stock-network

volumes:
  # 持久化應用數據
  app-data:
    driver: local
  # Nginx 快取
  nginx-cache:
    driver: local

networks:
  stock-network:
    driver: bridge

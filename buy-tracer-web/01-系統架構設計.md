# 股票買點追蹤 Web 系統 - 系統架構設計

## 1. 系統概述

### 1.1 專案名稱
**Buy Tracer Web** - 台灣股票買點追蹤 Web 應用系統

### 1.2 系統目標
- 提供 Web 介面讓使用者輸入股票代號進行技術分析
- 智能管理歷史數據，避免重複下載
- 自動增量更新至前一日收盤資料
- 視覺化呈現技術指標與買點訊號
- 提供清晰的分析方法說明

### 1.3 核心特性
- 📊 **歷史資料快取**: JSON 格式本地存儲，減少 API 請求
- 🔄 **增量更新機制**: 只下載缺失的日期區間
- 🎯 **雙策略分析**: 趨勢確立買點 + 拉回支撐買點
- 📈 **互動式圖表**: 基於 Plotly 的動態 K 線圖
- 📱 **響應式設計**: 支援桌面與移動設備

## 2. 系統架構

### 2.1 整體架構圖

```
┌─────────────────────────────────────────────────────────┐
│                       使用者介面                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  首頁        │  │  分析頁面    │  │  歷史記錄    │  │
│  │ (輸入代號)   │  │ (圖表+訊號)  │  │ (已追蹤)     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ▼ HTTP/AJAX
┌─────────────────────────────────────────────────────────┐
│                      Flask 後端                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │               路由層 (Routes)                     │   │
│  │  - GET  /                   (首頁)               │   │
│  │  - GET  /analyze/<ticker>   (分析頁面)           │   │
│  │  - POST /api/analyze        (分析 API)           │   │
│  │  - GET  /api/history        (歷史記錄)           │   │
│  │  - DELETE /api/cache/<ticker> (清除快取)         │   │
│  └──────────────────────────────────────────────────┘   │
│                           ▼                              │
│  ┌──────────────────────────────────────────────────┐   │
│  │              業務邏輯層 (Services)                 │   │
│  │  - StockDataService    (數據管理)                │   │
│  │  - IndicatorService    (指標計算)                │   │
│  │  - SignalService       (訊號生成)                │   │
│  │  - ChartService        (圖表生成)                │   │
│  └──────────────────────────────────────────────────┘   │
│                           ▼                              │
│  ┌──────────────────────────────────────────────────┐   │
│  │              資料存取層 (Data Access)              │   │
│  │  - CacheManager        (快取管理)                │   │
│  │  - TwstockClient       (股票數據源)              │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           ▼
┌─────────────────────────────────────────────────────────┐
│                      資料儲存                            │
│  ┌──────────────┐              ┌──────────────┐         │
│  │  JSON 快取   │              │  twstock API │         │
│  │  data/       │              │  (外部服務)  │         │
│  │  ├─ 2330.json│              └──────────────┘         │
│  │  ├─ 3363.json│                                       │
│  │  └─ ...      │                                       │
│  └──────────────┘                                       │
└─────────────────────────────────────────────────────────┘
```

### 2.2 技術棧

#### 後端
- **框架**: Flask 3.x
- **數據處理**: Pandas
- **股票數據源**: twstock
- **圖表生成**: Plotly
- **配置管理**: python-dotenv

#### 前端
- **模板引擎**: Jinja2
- **CSS 框架**: Bootstrap 5
- **JavaScript**:
  - Axios (AJAX 請求)
  - Plotly.js (圖表渲染)
  - Chart.js (輔助圖表)

#### 資料存儲
- **格式**: JSON
- **結構**: 扁平文件系統
- **位置**: `data/{ticker}.json`

## 3. 目錄結構

```
buy-tracer-web/
├── app.py                          # Flask 應用主程式
├── config.py                       # 配置文件
├── requirements.txt                # Python 依賴
├── .env.example                    # 環境變數範例
├── .gitignore                      # Git 忽略文件
│
├── services/                       # 業務邏輯層
│   ├── __init__.py
│   ├── stock_data_service.py       # 股票數據服務
│   ├── indicator_service.py        # 技術指標計算
│   ├── signal_service.py           # 買點訊號生成
│   └── chart_service.py            # 圖表生成服務
│
├── utils/                          # 工具函式
│   ├── __init__.py
│   ├── cache_manager.py            # 快取管理
│   └── date_utils.py               # 日期工具
│
├── models/                         # 數據模型
│   ├── __init__.py
│   └── stock_data.py               # 股票數據模型
│
├── routes/                         # 路由層
│   ├── __init__.py
│   ├── web_routes.py               # 網頁路由
│   └── api_routes.py               # API 路由
│
├── templates/                      # HTML 模板
│   ├── base.html                   # 基礎模板
│   ├── index.html                  # 首頁
│   ├── analyze.html                # 分析頁面
│   ├── history.html                # 歷史記錄
│   └── components/                 # 組件
│       ├── navbar.html             # 導航欄
│       ├── stock_info.html         # 股票資訊卡片
│       └── signal_table.html       # 訊號表格
│
├── static/                         # 靜態資源
│   ├── css/
│   │   └── style.css               # 自定義樣式
│   ├── js/
│   │   ├── main.js                 # 主要 JS 邏輯
│   │   ├── chart.js                # 圖表相關
│   │   └── api.js                  # API 請求封裝
│   └── images/
│       └── logo.png
│
├── data/                           # 數據存儲目錄
│   ├── cache/                      # JSON 快取
│   │   ├── 2330.json
│   │   └── 3363.json
│   └── logs/                       # 日誌文件
│       └── app.log
│
├── tests/                          # 測試文件
│   ├── __init__.py
│   ├── test_services.py
│   └── test_api.py
│
└── docs/                           # 設計文檔 (當前目錄)
    ├── 01-系統架構設計.md
    ├── 02-API規格文檔.md
    ├── 03-資料存儲格式.md
    ├── 04-前端介面設計.md
    └── 05-部署與使用說明.md
```

## 4. 核心模組設計

### 4.1 StockDataService (股票數據服務)

**職責**:
- 管理股票歷史數據的獲取與更新
- 實現智能快取策略
- 協調 CacheManager 與 TwstockClient

**核心方法**:
```python
class StockDataService:
    def get_stock_data(ticker: str, start_date: str = None) -> pd.DataFrame:
        """獲取股票數據（自動處理快取）"""

    def update_stock_data(ticker: str) -> dict:
        """增量更新至前一日"""

    def get_date_range(ticker: str) -> dict:
        """查詢已快取的日期範圍"""
```

### 4.2 CacheManager (快取管理器)

**職責**:
- JSON 文件的讀寫操作
- 快取有效性檢查
- 增量更新邏輯

**核心方法**:
```python
class CacheManager:
    def load_cache(ticker: str) -> dict:
        """載入快取數據"""

    def save_cache(ticker: str, data: pd.DataFrame) -> bool:
        """保存快取數據"""

    def get_missing_dates(ticker: str, target_date: str) -> list:
        """計算需要補足的日期"""

    def merge_data(existing: pd.DataFrame, new: pd.DataFrame) -> pd.DataFrame:
        """合併新舊數據"""
```

### 4.3 IndicatorService (技術指標服務)

**職責**:
- 計算 MA5, MA20, MA60
- 計算 MACD (DIF, DEM, OSC)
- 計算成交量均線

**核心方法**:
```python
class IndicatorService:
    def calculate_all(df: pd.DataFrame) -> pd.DataFrame:
        """計算所有技術指標"""

    def calculate_ma(df: pd.DataFrame, periods: list) -> pd.DataFrame:
        """計算移動平均線"""

    def calculate_macd(df: pd.DataFrame) -> pd.DataFrame:
        """計算 MACD 指標"""
```

### 4.4 SignalService (訊號服務)

**職責**:
- 實現雙買點策略邏輯
- 生成買點訊號標記
- 訊號摘要統計

**核心方法**:
```python
class SignalService:
    def generate_signals(df: pd.DataFrame) -> pd.DataFrame:
        """生成買點訊號"""

    def get_latest_signals(df: pd.DataFrame, limit: int = 5) -> list:
        """獲取最近 N 個訊號"""

    def get_signal_summary(df: pd.DataFrame) -> dict:
        """訊號摘要統計"""
```

### 4.5 ChartService (圖表服務)

**職責**:
- 生成 Plotly 圖表 JSON
- K 線圖配置
- MACD 子圖配置

**核心方法**:
```python
class ChartService:
    def create_candlestick_chart(df: pd.DataFrame, signals: pd.DataFrame) -> dict:
        """創建 K 線圖（含均線、訊號標記）"""

    def create_macd_chart(df: pd.DataFrame) -> dict:
        """創建 MACD 圖表"""

    def create_volume_chart(df: pd.DataFrame) -> dict:
        """創建成交量圖表"""
```

## 5. 數據流程

### 5.1 首次查詢流程

```
使用者輸入 "2330"
    ↓
CacheManager 檢查 data/cache/2330.json
    ↓ (不存在)
TwstockClient 下載完整歷史數據 (2024-01-01 ~ 前一日)
    ↓
CacheManager 保存 JSON
    ↓
IndicatorService 計算指標
    ↓
SignalService 生成訊號
    ↓
ChartService 生成圖表
    ↓
返回結果給前端
```

### 5.2 增量更新流程

```
使用者查詢 "2330" (已有快取)
    ↓
CacheManager 讀取 data/cache/2330.json
    ↓
檢查最新日期: 2024-12-05
    ↓
計算缺失日期: [2024-12-06, 2024-12-08] (排除週末)
    ↓
TwstockClient 僅下載缺失日期數據
    ↓
CacheManager 合併新舊數據並保存
    ↓
後續流程同上
```

## 6. 快取策略

### 6.1 快取鍵設計
- **格式**: `{ticker}.json`
- **範例**: `2330.json`, `3363.json`

### 6.2 快取更新時機
- 每次查詢時檢查
- 若最新日期 < 前一日 → 觸發增量更新
- 週末與假日自動跳過

### 6.3 快取失效策略
- 提供手動清除快取 API
- 可設定過期時間（可選）

## 7. 錯誤處理

### 7.1 常見錯誤場景
1. **股票代號不存在**: 返回 404 錯誤
2. **twstock API 失敗**: 返回 503 錯誤，提示稍後再試
3. **數據不足**: 指標計算需要至少 60 天數據
4. **JSON 損壞**: 自動刪除並重新下載

### 7.2 錯誤響應格式
```json
{
  "success": false,
  "error": {
    "code": "TICKER_NOT_FOUND",
    "message": "股票代號 9999 不存在",
    "details": null
  }
}
```

## 8. 效能優化

### 8.1 前端優化
- 圖表懶加載
- AJAX 非同步請求
- 防抖處理（搜尋輸入）

### 8.2 後端優化
- JSON 快取避免重複計算
- 增量更新減少 API 請求
- Pandas 向量化計算

### 8.3 資料優化
- 只保留必要欄位
- 日期索引加速查詢

## 9. 安全性考量

### 9.1 輸入驗證
- 股票代號格式檢查（純數字，4-6 位）
- 日期格式驗證
- SQL 注入防護（雖無 SQL，但需注意路徑注入）

### 9.2 速率限制
- 單 IP 每分鐘最多 10 次請求
- 防止惡意爬蟲

### 9.3 資料存取
- 限制只能訪問 data/cache/ 目錄
- 防止路徑穿越攻擊

## 10. 擴展性設計

### 10.1 未來可擴展功能
- 多股票比較
- 自定義指標參數
- Email/LINE 通知
- 策略回測
- 資料匯出 (CSV/Excel)

### 10.2 模組化設計
- Service 層可獨立替換
- 數據源可切換（twstock → yfinance）
- 圖表庫可替換（Plotly → ECharts）

## 11. 部署架構

### 11.1 開發環境
```
Flask Development Server (localhost:5000)
```

### 11.2 生產環境
```
Nginx (反向代理)
  ↓
Gunicorn (WSGI Server)
  ↓
Flask App (多 Worker)
  ↓
Data Storage (本地 JSON)
```

### 11.3 容器化（可選）
```dockerfile
# Dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["gunicorn", "-b", "0.0.0.0:5000", "app:app"]
```

## 12. 監控與日誌

### 12.1 日誌記錄
- 請求日誌: 記錄所有 API 請求
- 錯誤日誌: 記錄異常與錯誤
- 數據更新日誌: 記錄快取更新操作

### 12.2 日誌格式
```
[2024-12-09 10:30:15] INFO - GET /api/analyze - ticker=2330 - 200 OK - 1.23s
[2024-12-09 10:30:16] ERROR - TwstockClient failed - ticker=9999 - Connection timeout
```

---

**文件版本**: 1.0
**最後更新**: 2025-12-09
**作者**: System Architect
